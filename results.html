<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card-enter { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <!-- Sidebar: File List -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col h-full">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-database text-blue-500"></i> Saved Searches</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="fileList">
            <!-- Files will be injected here -->
            <div class="text-center text-gray-500 mt-4">Loading files...</div>
        </div>
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <a href="/" class="block w-full text-center bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                <i class="fa-solid fa-plus"></i> New Search
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden">
        
        <!-- Header -->
        <div class="bg-white p-4 border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
            <div id="currentFileName" class="text-lg font-semibold text-gray-700">
                Select a file to view results
            </div>
            
            <div class="flex space-x-2">
                <span class="text-sm text-gray-500 mr-2 self-center">View:</span>
                <button onclick="setView('grid')" id="btnGrid" class="p-2 rounded hover:bg-gray-100 text-blue-600">
                    <i class="fa-solid fa-border-all"></i>
                </button>
                <button onclick="setView('list')" id="btnList" class="p-2 rounded hover:bg-gray-100 text-gray-500">
                    <i class="fa-solid fa-list"></i>
                </button>
            </div>
        </div>

        <!-- Results Area -->
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="resultsArea">
            <div class="text-center text-gray-400 mt-20">
                <i class="fa-regular fa-folder-open text-4xl mb-4"></i>
                <p>No data selected</p>
            </div>
        </div>
    </div>

    <script>
        const fileListEl = document.getElementById('fileList');
        const resultsArea = document.getElementById('resultsArea');
        const currentFileName = document.getElementById('currentFileName');
        const btnGrid = document.getElementById('btnGrid');
        const btnList = document.getElementById('btnList');

        let currentView = 'grid'; // 'grid' or 'list'

        // 1. Load File List
        async function loadFiles() {
            try {
                const res = await fetch('/api/files');
                const files = await res.json();
                
                fileListEl.innerHTML = '';
                
                if (files.length === 0) {
                    fileListEl.innerHTML = '<div class="text-gray-500 text-sm p-2">No saved searches yet.</div>';
                    return;
                }

                files.forEach(file => {
                    const btn = document.createElement('div');
                    btn.className = 'p-3 mb-2 bg-gray-50 hover:bg-blue-50 rounded cursor-pointer border border-transparent hover:border-blue-200 transition text-sm font-medium text-gray-700 truncate';
                    btn.innerHTML = `<i class="fa-solid fa-file-code text-gray-400 mr-2"></i> ${file}`;
                    btn.onclick = () => loadResults(file);
                    fileListEl.appendChild(btn);
                });
            } catch (err) {
                fileListEl.innerHTML = '<div class="text-red-500 text-sm p-2">Error loading files.</div>';
            }
        }

        // 2. Load Specific Results
        async function loadResults(filename) {
            currentFileName.innerText = filename;
            resultsArea.innerHTML = '<div class="text-center mt-10"><i class="fa-solid fa-spinner fa-spin text-3xl text-blue-500"></i><p class="mt-2 text-gray-500">Loading data...</p></div>';

            try {
                const res = await fetch(`/api/read-file?filename=${filename}`);
                const data = await res.json();

                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format");
                }

                renderResults(data);

            } catch (err) {
                resultsArea.innerHTML = `<div class="text-red-500 text-center mt-10">Error loading data: ${err.message}</div>`;
            }
        }

        // 3. Render Data
        function renderResults(data) {
            resultsArea.innerHTML = '';
            
            // Container Class based on view
            const containerClass = currentView === 'grid' 
                ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6' 
                : 'flex flex-col gap-4 max-w-4xl mx-auto';

            const container = document.createElement('div');
            container.className = containerClass;

            if (data.length === 0) {
                resultsArea.innerHTML = '<div class="text-gray-500 text-center mt-10">No results found in this file.</div>';
                return;
            }

            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow border border-gray-100 p-4 card-enter relative hover:shadow-md transition';

                const imgUrl = item.image || `https://ui-avatars.com/api/?name=${item.name}&background=random`;
                
                // Layout changes based on view
                if (currentView === 'grid') {
                    card.innerHTML = `
                        <div class="flex flex-col items-center text-center h-full">
                            <img src="${imgUrl}" alt="${item.name}" class="w-20 h-20 rounded-full object-cover mb-3 border-2 border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-1 line-clamp-2">${item.name}</h3>
                            <p class="text-blue-600 font-mono text-sm mb-3">${item.phone}</p>
                            <div class="mt-auto w-full pt-3 border-t border-gray-100">
                                <a href="tel:${item.phone}" class="block w-full bg-blue-50 text-blue-600 py-1 rounded text-xs hover:bg-blue-100">
                                    <i class="fa-solid fa-phone"></i> Call
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    // List View
                    card.className = 'bg-white rounded-lg shadow border border-gray-100 p-4 card-enter flex items-center space-x-4';
                    card.innerHTML = `
                        <img src="${imgUrl}" alt="${item.name}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                            <p class="text-gray-500 text-sm">Scraped Result</p>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-blue-600 font-bold text-lg">${item.phone}</div>
                            <a href="tel:${item.phone}" class="text-xs text-gray-400 hover:text-blue-500"><i class="fa-solid fa-phone"></i> Call</a>
                        </div>
                    `;
                }

                container.appendChild(card);
            });

            resultsArea.appendChild(container);
        }

        // 4. Toggle View
        function setView(view) {
            currentView = view;
            
            // Update Button Styles
            if (view === 'grid') {
                btnGrid.classList.add('text-blue-600');
                btnGrid.classList.remove('text-gray-500');
                btnList.classList.remove('text-blue-600');
                btnList.classList.add('text-gray-500');
            } else {
                btnList.classList.add('text-blue-600');
                btnList.classList.remove('text-gray-500');
                btnGrid.classList.remove('text-blue-600');
                btnGrid.classList.add('text-gray-500');
            }

            // Re-render if data is loaded
            if (currentFileName.innerText !== 'Select a file to view results') {
                // Get the filename from current text, strip "Loading..." checks if needed
                // Simple re-trigger of the last loaded file (simplification)
                // Ideally store currentData in a variable, but for now we can re-fetch or just re-render
                // Let's re-fetch to be safe or store global 'currentData'. 
                // For simplicity, we'll just re-fetch the last file clicked.
                const filename = currentFileName.innerText;
                loadResults(filename); 
            }
        }

        // Init
        window.onload = loadFiles;
    </script>
</body>
</html>
